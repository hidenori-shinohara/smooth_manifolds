\begin{customthm}{4.1}
  Suppose $F: M \rightarrow N$ is a smooth map and $p \in M$.
  If $dF_p$ is surjective, then $p$ has a neighborhood $U$ such that $F\vert_U$ is a submersion.
  If $dF_p$ is injective, then $p$ has a neighborhood $U$ such that $F\vert_U$ is an immersion.
\end{customthm}

\begin{proof}
  Let $(U, \phi)$ be a chart containing $p$ and $(V, \psi)$ be a chart containing $F(p)$.
  We may assume $F(U) \subset V$.
  It suffices to show that if the Jacobian of $F$ with respect to $(U, \phi)$ is full rank at $p$, then it is full rank in some neighborhood of $p$ contained in $U$.
  Example 1.28 in the textbook shows that the set of full rank matrices is an open subset of $M(m \times n, \mathbb{R})$.
  We will use the notation $J\vert_{q}$ to denote the Jacobian of $F$ with respect to $(U, \phi)$ at $q \in U$.
  Then $J\vert_{p}$ is an element of an open subset of $M(m \times n, \mathbb{R})$.
  Each entry of $J\vert_{q}$ is of the from $\frac{\partial}{\partial x^i}(\psi^j \circ F \circ \phi)(\phi(q))$ where each $(\frac{\partial}{\partial x^i}(\psi^j \circ F \circ \phi)) \circ \phi$ is a smooth function.
  Therefore, there exists a neighborhood of $p$ such that the Jacobian matrix of $F$ with respect to $(U, \phi)$ is full rank.
\end{proof}

\begin{customexer}{4.3(Verification of Example 4.2)}
  Verify the following claims:
  \begin{enumerate}[label=(\alph*)]
    \item
      Suppose $M_1, \cdots, M_k$ are smooth manifolds.
      Then each of the projection maps $\pi_i: M_1 \times \cdots \times M_k \rightarrow M_i$ is a smooth submersion.
    \item
      If $\gamma: J \rightarrow M$ is a smooth curve in a smooth manifold $M$ with or without boundary, then $\gamma$ is a smooth immersion if and only if $\gamma'(t) \ne 0$ for all $t \in J$.
  \end{enumerate}
\end{customexer}

\begin{proof}
   $ $
  \begin{enumerate}[label=(\alph*)]
    \item
      Let $d_1, \cdots, d_k$ denote the dimensions of $M_1, \cdots, M_k$, respectively.
      Let $M = M_1 \times \cdots \times M_k$.

      (\ref{problem_2_2}) implies that $\pi_i$ is smooth for each $i$ by setting $F = \Id: M \rightarrow M$.
      Let $p = (p_1, \cdots, p_k) \in M$.
      Thus it suffices to show that the dimension of $d(\pi_i)_p(T_p(M))$ is the same as the dimension of $T_{p_i}(M_i)$.

      By Proposition 3.12, $\dim(T_p(M)) = \sum d_i$.
      Since the $\alpha$ defined in (\ref{problem_3_2}) is an isomorphism,
      \begin{equation}\label{exercise_4_3_eq_1}
        \dim(d(\pi_1)_p(T_p(M)) \oplus \cdots \oplus d(\pi_k)_p(T_p(M))) = \dim(T_p(M)) = \sum d_i.
      \end{equation}

      However, for each $i$, $d(\pi_i)_p(T_p(M)) \subset T_{p_i}M_i$.
      Thus $\dim(d(\pi_i)_p(T_p(M))) \leq \dim(T_{p_i}M_i) = d_i$.
      By (\ref{exercise_4_3_eq_1}), $\dim(d(\pi_i)_p(T_p(M))) = \dim(T_{p_i}M_i)$.
    \item
      $\gamma$ is a smooth immersion if and only if $d\gamma_t: T_tJ \rightarrow T_{\gamma(t)}M$ is injective for each $t \in J$.
      Since each $T_tJ$ is a 1-dimensional vector space spanned by $d/dt\vert_t$, $d\gamma_t$ is injective if and only if $d\gamma_t$ sends the basis element to a nonzero element.
      Finally, $\gamma'(t) = d\gamma(d/dt\vert_{t})$.
      Therefore, $\gamma$ is a smooth immersion if and only if $\gamma'(t) \ne 0$ for all $t \in J$.
  \end{enumerate}
\end{proof}

\begin{customexer}{4.4}\label{exercise_4_4}
  Show that a composition of smooth submersions is a smooth submersion, and a composition of smooth immersions is a smooth immersion.
  Give a counterexample to show that a composition of maps of constant rank need not have constant rank.
\end{customexer}

\begin{proof}
  Let $M, N, L$ be smooth manifolds with or without boundary, and $F: M \rightarrow N, G: N \rightarrow L$ be given.
  If $F, G$ are submersions, $dF_p$ and $dG_{F(p)}$ are surjective for each $p$.
  Then $d(G \circ F)_p = dG_{F(p)} \circ dF_p$ is surjective for each $p$ by (\ref{proof_prop_3_6}).
  Thus a composition of smooth submersions is a smooth submersion.
  By the exact same argument, a composition of smooth immersions is a smooth immersion.
  \todo[inline,caption={}]{
    Counterexample?
  }
\end{proof}

\begin{customthm}{4.5}\label{prop_4_5}
  Suppose $M$ and $N$ are smooth manifolds, and $F: M \rightarrow N$ is a smooth map.
  If $p \in M$ is a point such that $dF_p$ is invertible, then there are connected neighborhoods $U_0$ of $p$ and $V_0$ of $F(p)$ such that $F\vert_{U_0}: U_0 \rightarrow V_0$ is a diffeomorphism.
\end{customthm}

\begin{proof}
  Since $dF_p$ is invertible, $\dim(T_pM) = \dim(T_{F(p)}N)$.
  Let $n = \dim(T_pM)$.
  By (\ref{proposition_3_10}), $n$ is the dimension of $M$ and $N$.
  Let $(U, \phi), (V, \psi)$ be smooth charts containing $p, F(p)$, respectively, such that $\phi(p) = \psi(F(p)) = 0 \in \mathbb{R}^n$ and $F(U) \subset V$.
  Let $\hat{F} = \psi \circ F \circ \phi^{-1}$.
  Then $\hat{F}$ is a smooth map from an open subset $\hat{U} \subset \mathbb{R}^n$ into an open subset $\hat{V} \subset \mathbb{R}^n$.
  Then $d\hat{F}\vert_0 = d\psi_{F(p)} \circ dF_p \circ d\phi^{-1}_0$.
  Each function on the right hand side is bijective, so $d\hat{F}\vert_0$ is bijective.
  Since the differential of a smooth map between Euclidean spaces coincides with the total derivative of the map, we may apply the ordinary inverse function theorem.
  Thus there exist connected open subsets $\hat{U}_0 \subset \hat{U}$ and $\hat{V}_0 \subset \hat{V}$ both containing 0 such that $\hat{F}$ is a diffeomorphism from $\hat{U}_0$ to $\hat{V}_0$.
  Since $\phi$ and $\psi$ are homeomorphisms, $U_0$ and $V_0$ are connected neighborhoods of $p$ and $F(p)$ respectively.
  Finally, since $F = \psi^{-1} \circ \hat{F} \circ \phi$, $F$ is a diffeomorphism from $U_0$ to $V_0$.
\end{proof}

\begin{customthm}{4.6}
  $ $
  \begin{enumerate}[label=(\alph*)]
    \item 
      Every composition of local diffeomorphisms is a local diffeomorphism.
    \item
      Every finite product of local diffeomorphisms between smooth manifolds is a local diffeomorphism.
    \item
      Every local diffeomorphism is a local homeomorphism and an open map.
    \item
      The restriction of a local diffeomorphism to an open subsmanifold with or without boundary is a local diffeomorphism.
    \item
      Every diffeomorphism is a local diffeomorphism.
    \item
      Every bijective local diffeomorphism is a diffeomorphism.
  \end{enumerate}
\end{customthm}

\begin{proof}
  $ $
  \begin{enumerate}[label=(\alph*)]
    \item 
      Let $L, M, N$ be manifolds with or without boundary.
      Let $F: L \rightarrow M$ and $G: M \rightarrow N$ be local diffeomorphisms.
      Let $p \in L$.
      Then there exist open sets $U, V$ containing $p, F(p)$, respectively, such that $F(U), G(V)$ are open, and $F\vert_U, G\vert_V$ are diffeomorphisms.
      Let $W = F^{-1}(F(U) \cap V)$.
      Then $W$ is a neighborhood of $p$ such that $G(F(W)) = G(F(U) \cap V) = G(F(U)) \cap G(V)$, which is open in $N$.
      Moreover, $(G \circ F)\vert_{W}$ is clearly a diffeomorphism because a restriction of a diffeomorphism is a diffeomorphism and the composition of diffeomorphisms is a diffeomorphism.
    \item
      Let $M_1, \cdots, M_n, N_1, \cdots, N_n$ be $2n$ smooth manifolds and $F_i: M_i \rightarrow N_i$ be a local diffeomorphism for each $i = 1, \cdots, n$.
      Let $M = M_1 \times \cdots \times M_n, N = N_1 \times \cdots \times N_n$ and $F = F_1 \times \cdots \times F_n$.
      Let $p = (p_1, \cdots, p_n) \in M$ be given.
      Since each $F_i$ is a local diffeomorphism, there exists an open set $U_i$ containing $p_i$ such that $F_i(U_i)$ is open in $N_i$ and $F_i\vert_{U_i}$ is a diffeomorphism for each $i$.

      Then $U = U_1 \times \cdots \times U_n$ is an open subset of $M$ containing $p$ and $F(U) = F_1(U_1) \times \cdots \times F_n(U_n)$ is open in $N$.
      Since $F\vert_U = F_1\vert_{U_1} \times \cdots \times F_n\vert_{U_n}$, $F\vert_U$ is a diffeomorphism by (\ref{exercise_2_16}(b)).
    \item
      A diffeomorphism is a homeomorphism, so a local diffeomorphism is a local homeomorphism.
      Let $F: M \rightarrow N$ be a local diffeomorphism and an open set $U \subset M$ be given.
      For every $p \in U$, there exists a neighborhood $U_p$ of $p$ such that $F(U_p)$ is open and $F\vert_{U_p}$ is a diffeomorphism.
      $U_p \cap U$ is open in $M$.
      Since $F\vert_{U_p}$ is a diffeomorphism, $F\vert_{U_p}(U_p \cap U) = F(U_p \cap U)$ is open in $F(U_p)$.
      Since $F(U_p)$ is open, $F(U_p \cap U)$ is open in $N$.
      Then $F(U_p \cap U) = F(U_p) \cap F(U)$ is open in $N$.
      Since $F(U) = \cup_{p \in U} (F(U_p) \cap F(U))$, $F(U)$ is open in $N$.
    \item
      Let $F:M \rightarrow N$ be a local diffeomorphism.
      Let $U \subset M$ be an open submanifold with or without boundary.
      For every $p \in U$, there exists a neighborhood $U_p$ of $p$ in $M$ such that $F(U_p)$ is open in $N$ and $F\vert_{U_p}$ is a diffeomorphism.
      Since $U_p \cap U$ is open in $M$, $F(U_p \cap U)$ is open in $N$.
      Moreover, $F\vert_{U_p \cap U}$ is a diffeomorphism.
      Thus $F\vert_{U}$ is a local diffeomorphism.
    \item
      Let $F:M \rightarrow N$ be a diffeomorphism.
      For every point $p \in M$, the ``restriction" of $F$ to $M$ satisfies the definition.
    \item
      A local diffeomorphism is smooth, so a bijective local diffeomorphism is a diffeomorphism.
  \end{enumerate}
\end{proof}

\begin{customexer}{4.8}
  Suppose $M$ and $N$ are smooth manifolds (without boundary), and $F: M \rightarrow N$ is a map.
  \begin{enumerate}[label=(\alph*)]
    \item 
      $F$ is a local diffeomorphism if and only if it is both a smooth immersion and a smooth submersion.
    \item
      If $\dim M = \dim N$ and $F$ is either a smooth immersion or a smooth submersion, then it is a local diffeomorphism.
  \end{enumerate}
\end{customexer}

\begin{proof}
  Suppose that $F$ is a local diffeomorphism.
  Let $p \in M$.
  Then $p$ has a neighborhood $U$ such that $F\vert_U$ is a diffeomorphism.
  Then $d(F\vert_U)_p$ is an isomorphism by (\ref{proof_prop_3_6}).
  Clearly, $dF_p = d(F\vert_U)_p$.
  Therefore, $dF_p$ is an isomorphism for each $p$.
  In other words, $F$ is both a smooth immersion and submersion.

  Suppose that $F$ is both a smooth immersion and submersion.
  Then $dF_p$ is injective and surjective for each $p \in M$.
  Therefore, $dF_p$ is invertible for each $p \in M$.
  By (\ref{prop_4_5}), there exist open sets $U, V$ containing $p, F(p)$ such that $F:U \rightarrow V$ is a diffeomorphism.
  This is exactly the definition of a local diffeomorphism.

  Since $\dim M = \dim N$, either the injectivity or surjectivity of $dF_p$ implies that $dF_p$ is an isomorphism.
  Then (b) follows from (a).
\end{proof}

\begin{customthm}{4.13}
  Let $M$ and $N$ be smooth manifolds, let $F: M \rightarrow N$ be a smooth map, and suppose $M$ is connected.
  Then the following are equivalent:
  \begin{enumerate}[label=(\alph*)]
    \item 
      For each $p \in M$ there exist smooth charts containing $p$ and $F(p)$ in which the coordinate representation of $F$ is linear.
    \item
      $F$ has constant rank.
  \end{enumerate}
\end{customthm}

\begin{proof}
  Suppose (a).
  Let $p \in M$.
  Then the coordinate representation of $dF$ is linear in some neighborhood $U$ of $p$.
  This implies that the rank of $dF$ is constant in $U$.
  Since $M$ is connected, this implies that the rank of $dF$ is constant throughout $M$.

  On the other hand, suppose (b).
  Let $p \in M$.
  Then the rank theorem guarantees the existence of smooth charts $(U, \phi)$ for $M$ centered at $p$ and $(V, \psi)$ for $N$ centered at $F(p)$ such that $F(U) \subset V$ in which $F$ has a coordinate representation of the form $\hat{F}(x^1, \cdots, x^r, x^{r + 1}, \cdots, x^m) = (x^1, \cdots, x^r, 0, \cdots, 0)$.
  $\hat{F}$ is clearly linear because 
  \begin{align*}
    \hat{F}(c(x^1, \cdots, x^m) + (y^1, \cdots, y^m))
      &= \hat{F}(cx^1 + y^1, \cdots, cx^m + y^m) \\
      &= (cx^1 + y^1, \cdots, cx^r + y^r, 0, \cdots, 0) \\
      &= c(x^1, \cdots, x^r, 0, \cdots, 0) + (y^1, \cdots, y^r, 0, \cdots, 0).
  \end{align*}
\end{proof}

\begin{customexer}{(4.16)}
  Show that every composition of smooth embeddings is a smooth embedding.
\end{customexer}

\begin{proof}
  We showed that a composition of smooth immersions is a smooth immersion in (\ref{exercise_4_4}).
  Every composition of topological embeddings is a topological embedding.
  Therefore, every composition of smooth embeddings is a smooth embedding.
\end{proof}

\begin{customexmp}{(4.17)}
  $ $
  \begin{enumerate}[label=(\alph*)]
    \item 
      If $M$ is a smooth manifold with or without boundary and $U \subset M$ is an open submanifold, the inclusion map $U \mapsto M$ is a smooth embedding.
    \item
      If $M_1, \cdots, M_k$ are smooth manifolds and $p_i \in M_i$ are arbitrarily chosen points, each of the maps $i_j: M_j \rightarrow M_1 \times \cdots \times M_k$ given by
      \begin{align*}
        i_j(q) = (p_1, \cdots, p_{j - 1}, q, p_{j + 1}, \cdots, p_k)
      \end{align*}
      is a smooth embedding.
      In particular, the inclusion map $\mathbb{R}^n \rightarrow \mathbb{R}^{n + k}$ given by sending $(x^1, \cdots, x^n)$ to $(x^1, \cdots, x^n, 0, \cdots, 0)$ is a smooth embedding.
  \end{enumerate}
\end{customexmp}

\begin{proof}
  $ $
  \begin{enumerate}[label=(\alph*)]
    \item 
      $i$ is clearly a topological embedding.
      By Proposition 3.9, $di_p: T_pU \rightarrow T_pM$ is an isomorphism for each $p \in U$.
      Therefore, $i$ is a smooth immersion, which means $i$ is a smooth embedding.
    \item
      Since a cross product of finitely many smooth manifolds is a smooth manifold, it suffices to show that $i: M \rightarrow M \times N$ is a smooth embedding.
      $i$ is clearly a topological embedding.
      Moreover, for any $p \in M$, $d(\pi_1)_p \circ di_p = d(\pi_1 \circ i)_p = d\Id_p = \Id$, so $di_p$ must be injective.
      In other words, $i$ is a smooth immersion.
      Therefore, $i$ is a smooth embedding.
  \end{enumerate}
\end{proof}
